name: Build all tags -> versions artifact (robust update bypass + MicroPython inject)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"

permissions:
  contents: read

jobs:
  build_all_tags:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout (full history + tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            expect git rsync coreutils \
            xorriso grub-pc-bin grub-common mtools nasm \
            build-essential bison flex libgmp3-dev libmpc-dev libmpfr-dev texinfo \
            libisl-dev wget tar xz-utils

      - name: Cache i686-elf toolchain
        uses: actions/cache@v4
        with:
          path: /opt/cross
          key: i686-elf-toolchain-v1

      - name: Build i686-elf toolchain (if needed)
        run: |
          set -euo pipefail
          if [ -x /opt/cross/bin/i686-elf-gcc ]; then exit 0; fi

          sudo mkdir -p /opt/cross
          sudo chown -R "$USER":"$USER" /opt/cross
          mkdir -p /tmp/toolchain
          cd /tmp/toolchain

          BINUTILS=2.42
          GCC=14.1.0

          wget -q https://ftp.gnu.org/gnu/binutils/binutils-$BINUTILS.tar.xz
          wget -q https://ftp.gnu.org/gnu/gcc/gcc-$GCC/gcc-$GCC.tar.xz
          tar -xf binutils-$BINUTILS.tar.xz
          tar -xf gcc-$GCC.tar.xz

          mkdir build-binutils && cd build-binutils
          ../binutils-$BINUTILS/configure \
            --target=i686-elf --prefix=/opt/cross \
            --disable-nls --disable-werror
          make -j$(nproc)
          make install
          cd ..

          cd gcc-$GCC
          ./contrib/download_prerequisites
          cd ..

          mkdir build-gcc && cd build-gcc
          ../gcc-$GCC/configure \
            --target=i686-elf --prefix=/opt/cross \
            --disable-nls --enable-languages=c --without-headers
          make -j$(nproc) all-gcc all-target-libgcc
          make install-gcc install-target-libgcc

      - name: Add toolchain to PATH
        run: echo "/opt/cross/bin" >> "$GITHUB_PATH"

      - name: Prepare MicroPython source
        run: |
          set -euo pipefail
          if [ ! -d /tmp/micropython-src ]; then
            git clone --depth 1 https://github.com/micropython/micropython.git /tmp/micropython-src
          else
            cd /tmp/micropython-src
            git reset --hard
            git pull
          fi

      - name: Build all tags
        run: |
          set -euo pipefail
          git fetch --tags --force

          OUT="/tmp/versions"
          rm -rf "$OUT"
          mkdir -p "$OUT"

          ############################
          # EXPECT SCRIPT (HARD STOP UPDATES)
          ############################
          EXPECT="/tmp/run_build.expect"
          cat > "$EXPECT" <<'EOF'
          set timeout -1
          log_user 1
          spawn bash -lc "./build.sh"

          expect {
            # HARD STOP: update checks
            -re "(?i)checking for repository updates" {
              send "n\r"
              exp_continue
            }
            -re "(?i)update repository now" {
              send "n\r"
              exp_continue
            }
            -re "(?i)updates are available" {
              send "n\r"
              exp_continue
            }
            -re "(?i)show changes" {
              send "n\r"
              exp_continue
            }

            # Commit counter menu
            -re "(?i)Commit build count to GitHub\\?" {
              send "3\r"
              exp_continue
            }
            -re "#\\?" {
              send "3\r"
              exp_continue
            }

            # Architecture menu
            -re "(?i)Enter choice" {
              send "1\r"
              exp_continue
            }
            -re "(?i)choice:" {
              send "1\r"
              exp_continue
            }

            eof
          }
          EOF

          ############################
          # FAKE GIT (compile only)
          ############################
          FAKEBIN="/tmp/fakebin"
          mkdir -p "$FAKEBIN"
          cat > "$FAKEBIN/git" <<'EOF'
          #!/usr/bin/env bash
          case "${1:-}" in
            pull|fetch|clone|remote|ls-remote)
              echo "CI NOTICE: git $1 disabled during compile"
              exit 0
              ;;
            submodule)
              if [[ "${2:-}" == "update" ]]; then exit 0; fi
              exec /usr/bin/git "$@"
              ;;
            *)
              exec /usr/bin/git "$@"
              ;;
          esac
          EOF
          chmod +x "$FAKEBIN/git"

          mapfile -t TAGS < <(git tag -l | sort -V)
          FAIL=0

          for TAG in "${TAGS[@]}"; do
            echo "========================================"
            echo "Building tag: $TAG"
            echo "========================================"

            git checkout -f "$TAG"
            git clean -fdx

            mkdir -p "$OUT/$TAG"

            if [[ ! -f build.sh ]]; then
              echo "SKIP: no build.sh" | tee "$OUT/$TAG/build.log"
              continue
            fi

            chmod +x build.sh

            # Inject MicroPython
            rm -rf micropython
            mkdir micropython
            rsync -a --delete --exclude=.git /tmp/micropython-src/ micropython/

            set +e
            PATH="$FAKEBIN:$PATH" expect -f "$EXPECT" | tee "$OUT/$TAG/build.log"
            RC=${PIPESTATUS[0]}
            set -e

            ISO_OK=0
            if [[ -f exocore.iso ]]; then
              cp exocore.iso "$OUT/$TAG/"
              ISO_OK=1
            fi

            if [[ "$RC" -ne 0 || "$ISO_OK" -ne 1 ]]; then
              echo "BUILD FAILED" | tee -a "$OUT/$TAG/build.log"
              FAIL=$((FAIL+1))
            else
              echo "BUILD OK" | tee -a "$OUT/$TAG/build.log"
            fi
          done

          echo "Done. Failed builds: $FAIL"

      - name: Upload versions artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: versions
          path: /tmp/versions
          retention-days: 90
